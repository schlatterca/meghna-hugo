{{ define "main" }}

{{ partial "navigation.html" . }}

{{/* - partial "footer.html" . -*/}}

<section class="section">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 offset-lg-2 text-center">
        <p id="this_article_type"><a href="..\"{{ .Type }}>{{ .Type }}</a></p>
        <h1 id="this_article_title">{{ .Title }}</h1>
        <p id="this_article_author">by {{ .Params.author }}</p>
        
      </div>

      {{ if .Description }}
      <div class="synopsis_box">
        <p class="synopsis">Synopsis: {{ .Description }}</p>
        <div class="open_synopsis_box">+</div>
      </div>
      {{ end }}

      <div class="col-lg-8 offset-lg-2">
        <div class="post-single-content articleContent">
          {{ .Content }}
        </div>
        {{ if .Params.footnotes }}
        <div id="extraspace"></div>
        {{ end }}
      </div>

      {{ if .Params.footnotes }}
      <div class="footnotes_box">
        <p class="footnotes">Footnotes: {{ .Params.footnotes }}</p>
        <div class="open_footnotes_box">+</div>
      </div>
      {{ end }}

    </div>
  </div>

  <!--if there are footnotes, the box appears on each footnote number-->
  {{ if .Params.footnotes }}
  <div id="fn_appear"></div>
  {{ end }}

</section>

<footer>
  <div id="footer" class="foot1" onmouseover="toggleFooter(this)" onmouseout="toggleFooter(this)">
    <p class="footer_title footitle1">Barberini Harp Project</p>
    <div class="footer_insidebox_1">
      <p class="footer_insidetext">{{ .Params.barberiniharpproject }}</p>
    </div>
  </div>
  <div id="footer" class="foot2" onmouseover="toggleFooter(this)" onmouseout="toggleFooter(this)">
    <p class="footer_title footitle2">Related Research</p>
    <div class="footer_insidebox_2">
      <!--p class="footer_insidetext">Related Research here</p-->
    </div>
  </div>
  <div id="footer" class="foot3" onmouseover="toggleFooter(this)" onmouseout="toggleFooter(this)">
    <p class="footer_title footitle3">External Links</p>
    <div class="footer_insidebox_3">
      <p class="footer_insidetext extlinks">{{ .Params.externallinks }}</p>
    </div>
  </div>
  <div id="footer" class="foot4" onmouseover="toggleFooter(this)" onmouseout="toggleFooter(this)">
    <p class="footer_title footitle4">Tags</p>
    <div class="footer_insidebox_3">
      <p id="tagspers" class="footer_insidetext tagspers">Persons:</p>
      <p class="footer_insidetext tagssubj">Subjects: {{ .Params.tags }}</p>
      <p class="footer_insidetext tagstime">Timeline: {{ .Params.tags }}</p>
      <p class="footer_insidetext tagsmap">Map: {{ .Params.tags }}</p>
    </div>
  </div>
  <div id="footer" class="foot5" onmouseover="toggleFooter(this)" onmouseout="toggleFooter(this)">
    <p class="footer_title footitle5">Downloads</p>
    <div class="footer_insidebox_5">
      <p class="footer_insidetext">{{ .Params.downloads }}</p>
    </div>
  </div>
</footer>

<script>
  //add links to each person that appears in the person_tag section
  var persontags_list = {{ .Params.person_tag }};
  var words = [];
  for (let i = 0; i < persontags_list.length; i++) {
    if (persontags_list[i].includes(' ')){
      var nameToSwap = persontags_list[i].split(' ');
      var first = nameToSwap[0];
      var last = nameToSwap[nameToSwap.length - 1];
      nameToSwap[0] = last;
      nameToSwap[nameToSwap.length - 1] = first;
      var nameSwapped = nameToSwap.join(' ').replace(' ', '%20');
    } else {
      var nameSwapped = persontags_list[i];
    }
    var Obj = {}
    Obj.word = persontags_list[i];
    Obj.link = nameSwapped;
    words.push(Obj);
  }

  $.each(words,
    function() {
      var search = this;
      $('span#person_tag').each(
        function() {
          if ($(this).text() === search.word) {
            $(this).html('<a href="https://harfenlabor.netlify.app/persontags#' + search.link + '">' + search.word + '</a>');
          }
        }
      );
    }
  );

  //FOOTER:
  //make each external link clickable (External Links)
  var extlinks = {{ .Params.externallinks }};

  if (extlinks.includes(', ')){
    document.getElementsByClassName('footer_insidebox_3')[0].innerHTML = "";
    var extlinks_array = extlinks.split(', ');
    for (let i = 0; i < extlinks_array.length; i++) {
      let extlink_par = document.createElement('p');
      let extlink_text = document.createTextNode(extlinks_array[i]);
      extlink_par.setAttribute('class', 'footer_insidetext extlinks');
      extlink_par.appendChild(extlink_text);
      document.getElementsByClassName('footer_insidebox_3')[0].append(extlink_par);
    }
  }

  $('p.extlinks').each(
    function() {
      $(this).html('<a href="https://' + this.innerText + '">' + this.innerText + '</a>');
    }
  );



  //make each person tag clickable (Tags)

  //var persontags_list = {{ .Params.person_tag }};

  console.log(document.getElementById('tagspers'));

  var tagspers_count = 0;

  $.each(words,
    function() {
      console.log(this, tagspers_count);
      var search = this;

      let tagspers_span = document.createElement('span');
      let tagspers_text = document.createTextNode({{ .Params.person_tag }}[tagspers_count]);
      let tagspers_space = document.createTextNode(' ');
      tagspers_span.setAttribute('class', 'footer_insidetext');
      tagspers_span.setAttribute('id', 'tagspers');
      tagspers_span.appendChild(tagspers_text);
      document.getElementById('tagspers').append(tagspers_span);

      tagspers_count = tagspers_count+1;

      $('span#tagspers').each(
        function() {
          //console.log(this);
          if ($(this).text() === search.word) {
            console.log("yes", search, search.word, search.link);
            $(this).html('<a href="https://harfenlabor.netlify.app/persontags#' + search.link + '">' + search.word + '</a>');
          } else {
            console.log("no", search, search.word, search.link);
          }
        }
      );
    }
  );




  //make footnotes interactive
  //wait until the page is loaded and footnotes are replaced
  window.addEventListener('load', function () {
    var footnotes = document.getElementsByClassName('footnotes');

    if ( footnotes ) {

      for (let i = 0; i < footnotes.length; i++) {

        $('sup').each(
          function() {
            $(this).prop('id', 'footnote');

            /*$(this).click(function() {
              alert(footnotes[this.innerText].innerText);
              return false; //break the "each" loop
            });*/

            $(this).on("mouseover", function(e) {
              var box = $("#fn_appear");
              var y = e.pageY;
              var x = e.pageX;

              var fn_paragraph = document.createElement('p');
              var fn_insideText = document.createTextNode(footnotes[this.innerText].innerText);
              fn_paragraph.setAttribute('class', 'footnotes');
              fn_paragraph.appendChild(fn_insideText);

              if (box.children().length > 0 ) {
                box.empty();
              }
              box.append(fn_paragraph);

              box.css('display', 'block');
              box.css('position', 'absolute');

              if(x < window.innerWidth/2){
                x = e.pageX;
                box.css("left", x);
                box.css("right", "unset");
              } else {
                x = window.innerWidth-e.pageX;
                box.css("left", "unset");
                box.css("right", x);
              }
              box.css("top", y);
            });

            $(this).on("mouseout", function(e) {
              var box = $("#fn_appear");
              box.css('display', 'none');
            });
          }
        );
        break; //break the "for" loop

      }
    }
  })


  //make a downloadable pdf
  var element = document.getElementsByClassName('container')[1];
  var opt = {
    margin:       0,
    filename:     'myfile.pdf',
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { scale: 2 },
    jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
  };

  $("#this_article_title").on("click", function() {
    var worker = html2pdf().set(opt).from(element).save();
    //html2pdf().set(opt).from(element).save();
  })
  

</script>

{{ end }}
